# Crypto-2｜baby_next

## Tag

RSA，费马分解攻击
***
## Writeup

由题意，q 是通过从 p 开始连续调用 114514 次 next_prime() 得到的，这意味着 p 和 q 非常接近，可以通过费马分解攻击

- 费马分解定理：任何奇数 n 都可以表示为两个平方数之差

假设 $n = a^2- b^2 = (a+b)(a-b)$，如果 $n = pq$，令 $a = \frac{p+q}{2}，b = \frac{p-q}{2}$，当 $p\approx q$ 时：
$\sqrt{n}\approx \sqrt{(p·q)} \approx p \approx q$，我们从 $a = \lceil \sqrt{n} \rceil$ 开始递增搜索，检查 $a^2 - n$ 是否为完全平方数，
如果是，则 $b^2 = a^2 - n$，可以得到 $p = a+b, q = a-b$，Payload 如下：

```python
from Crypto.Util.number import *
import gmpy2

n = 96742777571959902478849172116992100058097986518388851527052638944778038830381328778848540098201307724752598903628039482354215330671373992156290837979842156381411957754907190292238010742130674404082688791216045656050228686469536688900043735264177699512562466087275808541376525564145453954694429605944189276397
c = 17445962474813629559693587749061112782648120738023354591681532173123918523200368390246892643206880043853188835375836941118739796280111891950421612990713883817902247767311707918305107969264361136058458670735307702064189010952773013588328843994478490621886896074511809007736368751211179727573924125553940385967
e = 65537

a = gmpy2.isqrt(n)
if a * a < n:
    a += 1

while True:
    b_squared = a * a - n
    
    b = gmpy2.isqrt(b_squared)
    if b * b == b_squared:
        p = a - b
        q = a + b
        print(f"[+] p = {p}")
        print(f"[+] q = {q}")
        break
    
    a += 1

phi = (p - 1) * (q - 1)
d = pow(e, -1, phi)
m = pow(c, d, n)

flag = long_to_bytes(m)
print(f"\n[+] Flag: {flag.decode()}")
```

最终 flag：`moectf{vv0W_p_m1nu5_q_i5_r34l1y_sm4lI}`
